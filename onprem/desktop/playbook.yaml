- name: Install mise on homelab desktop
  hosts: homelabdesktop
  vars:
    target_user: "{{ lookup('env', 'USER') }}"
  tasks:
    - name: Show current user info
      ansible.builtin.debug:
        msg: |
          Current user: {{ ansible_facts.user_id }}
          Current user home: {{ ansible_facts.user_dir }}
          Effective user (with become): {{ ansible_facts.env.USER }}
          SSH user: {{ ansible_facts.ssh_user | default(ansible_facts.user_id) }}

    # sudo atp update && sudo apt install curl etc...
    - name: Update apt cache and install core dependencies
      ansible.builtin.apt:
        name:
          - curl
          - btop
        state: present
        update_cache: yes
      become: true

    # sudo atp update && sudo apt install curl etc...
    - name: Install GPU driver
      ansible.builtin.apt:
        name:
          - nvidia-driver-580-open
        state: present
      become: true

    # sudo install -dm 755 /etc/apt/keyrings
    - name: Create keyrings directory
      ansible.builtin.file:
        path: /etc/apt/keyrings
        state: directory
        mode: '0755'
      become: true

    # curl -fSs https://mise.jdx.dev/gpg-key.pub | sudo tee /etc/apt/keyrings/mise-archive-keyring.pub 1> /dev/null
    - name: Download mise GPG key
      ansible.builtin.get_url:
        url: https://mise.jdx.dev/gpg-key.pub
        dest: /etc/apt/keyrings/mise-archive-keyring.pub
        mode: '0644'
      become: true

    # echo "deb [signed-by=/etc/apt/keyrings/mise-archive-keyring.pub arch=amd64] https://mise.jdx.dev/deb stable main" | sudo tee /etc/apt/sources.list.d/mise.list
    - name: Add mise repository
      ansible.builtin.apt_repository:
        repo: "deb [signed-by=/etc/apt/keyrings/mise-archive-keyring.pub arch=amd64] https://mise.jdx.dev/deb stable main"
        state: present
        filename: mise
      become: true

    # sudo apt update
    - name: Update apt cache after adding repository
      ansible.builtin.apt:
        update_cache: yes
      become: true

    # sudo apt install -y mise
    - name: Install mise
      ansible.builtin.apt:
        name: mise
        state: present
      become: true

    - name: Add mise activation to bashrc
      ansible.builtin.lineinfile:
        path: "/home/{{ target_user }}/.bashrc"
        line: 'eval "$(mise activate bash)"'
        create: yes
        state: present
      become_user: "{{ target_user }}"

    - name: Copy local config to remote
      ansible.builtin.copy:
        src: "files/"
        dest: "/home/{{ target_user }}/"
        owner: "{{ target_user }}"
        group: "{{ target_user }}"
      become_user: "{{ target_user }}"

    - name: Install mise dependencies
      ansible.builtin.shell: mise trust && mise activate && mise install
      become_user: "{{ target_user }}"

    # sudo apt-get install ca-certificates curl
    - name: Install pre-requisite packages
      ansible.builtin.apt:
        name:
          - ca-certificates
          - curl
        state: present
      become: true

    # sudo install -m 0755 -d /etc/apt/keyrings
    - name: Ensure keyrings directory exists
      ansible.builtin.file:
        path: /etc/apt/keyrings
        state: directory
        owner: root
        group: root
        mode: '755'
      become: true

    # sudo curl -fsSL https://download.docker.com/linux/ubuntu/gpg -o /etc/apt/keyrings/docker.asc
    # sudo chmod a+r /etc/apt/keyrings/docker.asc
    - name: Download Docker gpg key
      ansible.builtin.get_url:
        url: https://download.docker.com/linux/ubuntu/gpg
        dest: /etc/apt/keyrings/docker.asc
        owner: root
        group: root
        mode: '0444'
      become: true

    # echo \
    # "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.asc] https://download.docker.com/linux/ubuntu \
    # $(. /etc/os-release && echo "${UBUNTU_CODENAME:-$VERSION_CODENAME}") stable" | \
    # sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
    - name: Get system architecture
      ansible.builtin.command: dpkg --print-architecture
      register: dpkg_arch
      changed_when: false
      become: true

    - name: Add Docker repository
      ansible.builtin.apt_repository:
        repo: "deb [arch={{ dpkg_arch.stdout }} signed-by=/etc/apt/keyrings/docker.asc] https://download.docker.com/linux/ubuntu {{ ansible_facts['distribution_release'] }} stable"
        state: present
        filename: docker
      become: true

    # sudo apt-get update
    - name: Update apt cache
      ansible.builtin.apt:
        update_cache: yes
        cache_valid_time: 3600
      become: true

    # sudo apt-get install docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin
    - name: Install Docker
      ansible.builtin.apt:
        name:
          - docker-ce
          - docker-ce-cli
          - containerd.io
          - docker-buildx-plugin
          - docker-compose-plugin
        state: present
      become: true

    # sudo usermod -aG docker $USER
    - name: Add user to docker group
      ansible.builtin.user:
        name: "{{ target_user }}"
        groups: docker
        append: yes
      become: true

    # Verify that the installation is successful by running the hello-world image
    - name: Run Docker hello-world container
      community.docker.docker_container:
        name: hello-world
        image: hello-world
        state: started
        detach: false
        auto_remove: true
      become: true

    # Docker doesn't have the NVIDIA Container Toolkit installed. You need to install it so Docker can access the GPU.

    # curl -fsSL https://nvidia.github.io/libnvidia-container/gpgkey | sudo gpg --dearmor -o /usr/share/keyrings/nvidia-container-toolkit-keyring.gpg
    - name: Download NVIDIA Container Toolkit GPG key
      ansible.builtin.shell: |
        curl -fsSL https://nvidia.github.io/libnvidia-container/gpgkey | gpg --dearmor -o /usr/share/keyrings/nvidia-container-toolkit-keyring.gpg
      args:
        creates: /usr/share/keyrings/nvidia-container-toolkit-keyring.gpg
      become: true

    # curl -s -L https://nvidia.github.io/libnvidia-container/stable/deb/nvidia-container-toolkit.list | \
    #   sed 's#deb https://#deb [signed-by=/usr/share/keyrings/nvidia-container-toolkit-keyring.gpg] https://#g' | \
    #   sudo tee /etc/apt/sources.list.d/nvidia-container-toolkit.list
    - name: Add NVIDIA Container Toolkit repository
      ansible.builtin.shell: |
        curl -s -L https://nvidia.github.io/libnvidia-container/stable/deb/nvidia-container-toolkit.list | \
          sed 's#deb https://#deb [signed-by=/usr/share/keyrings/nvidia-container-toolkit-keyring.gpg] https://#g' > /etc/apt/sources.list.d/nvidia-container-toolkit.list
      args:
        creates: /etc/apt/sources.list.d/nvidia-container-toolkit.list
      become: true

    # sudo apt update && sudo apt install nvidia-container-toolkit
    - name: Update apt cache after adding NVIDIA repository
      ansible.builtin.apt:
        update_cache: yes
      become: true

    - name: Install NVIDIA Container Toolkit
      ansible.builtin.apt:
        name: nvidia-container-toolkit
        state: present
      become: true

    # sudo nvidia-ctk runtime configure --runtime=docker
    - name: Configure Docker to use NVIDIA runtime
      ansible.builtin.command: nvidia-ctk runtime configure --runtime=docker
      become: true

    # sudo systemctl restart docker
    - name: Restart Docker service
      ansible.builtin.systemd:
        name: docker
        state: restarted
      become: true

  # # docker run --rm --gpus all nvidia/cuda:12.0-base nvidia-smi
  # - name: Test GPU access in Docker
  #   community.docker.docker_container:
  #     name: nvidia-smi-test
  #     image: nvidia/cuda:12.0-base
  #     command: nvidia-smi
  #     device_requests:
  #       - driver: nvidia
  #         count: -1
  #         capabilities:
  #           - ['gpu']
  #     detach: false
  #     auto_remove: true
  #   become: true
  #   register: nvidia_smi_result
  #
  # - name: Show nvidia-smi output
  #   ansible.builtin.debug:
  #     var: nvidia_smi_result
