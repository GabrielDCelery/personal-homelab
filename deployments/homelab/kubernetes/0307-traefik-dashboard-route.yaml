# HTTPRoute - Routes Traefik dashboard traffic
# - What it is: Routes /traefik/* paths to Traefik's dashboard/API
# - Comparison to Docker: Replaces Traefik labels:
#   - "traefik.http.routers.dashboard.rule=PathPrefix(`/traefik/api`) || PathPrefix(`/traefik/dashboard`)"
#   - "traefik.http.routers.dashboard.service=api@internal"
# - Behavior: All requests to /traefik/* get routed to Traefik's dashboard on port 8080
# - Why: Keeps dashboard accessible at same paths as Docker setup
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: traefik-dashboard
  namespace: homelab
spec:
  # - What it does: Attaches this route to the Gateway
  # - Behavior: Listens on the "http" listener of homelab-gateway
  # - Traffic flow: Cloudflared → Gateway:80 → This HTTPRoute → Traefik dashboard:8080
  parentRefs:
    - name: homelab-gateway
      namespace: homelab
      sectionName: http

  # - What it is: Routing rules
  # - Priority: This is more specific than Homepage's "/" route, so it matches first
  rules:
    # Match all /traefik/* paths
    # - PathPrefix /traefik: Matches /traefik/dashboard, /traefik/api, etc.
    # - Comparison to Docker: PathPrefix(`/traefik/api`) || PathPrefix(`/traefik/dashboard`)
    # - Why one rule: PathPrefix /traefik covers both /api and /dashboard subdirectories
    - matches:
        - path:
            type: PathPrefix
            value: /traefik
      # - backendRefs: Route to Traefik's dashboard port
      # - name: reverse-proxy = The Traefik Service from 0304-traefik-service.yaml
      # - port: 8080 = Dashboard/API port
      # - Behavior: Forwards /traefik/* to port 8080 (Traefik's basepath handles the rest)
      # - Note: No path rewriting needed because --api.basepath=/traefik is set
      # - Result: /traefik/dashboard → port 8080 → Traefik dashboard with basepath
      backendRefs:
        - name: reverse-proxy
          port: 8080
