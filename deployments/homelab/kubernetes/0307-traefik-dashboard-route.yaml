# HTTPRoute - Routes Traefik dashboard traffic
# - What it is: Routes /traefik/* paths to Traefik's dashboard/API
# - Comparison to Docker: Replaces Traefik labels:
#   - "traefik.http.routers.dashboard.rule=PathPrefix(`/traefik/api`) || PathPrefix(`/traefik/dashboard`)"
#   - "traefik.http.routers.dashboard.service=api@internal"
# - Behavior: All requests to /traefik/* get routed to Traefik's dashboard on port 8080
# - Known issue: Dashboard JavaScript makes calls to /api which may not work correctly
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: traefik-dashboard
  namespace: homelab
spec:
  # - What it does: Attaches this route to the Gateway
  # - Behavior: Listens on the "http" listener of homelab-gateway
  # - Traffic flow: Cloudflared → Gateway:80 → This HTTPRoute → Traefik dashboard:8080
  parentRefs:
    - name: homelab-gateway
      namespace: homelab
      sectionName: http

  hostnames:
    - "traefik-dev.gaborzeller.com"
  # - What it is: Routing rules
  # - Priority: This is more specific than Homepage's "/" route, so it matches first
  rules:
    # Match all /* paths
    # - PathPrefix /: Matches /dashboard, /api, etc.
    - matches:
        - path:
            type: PathPrefix
            value: /
      # - backendRefs: Route to Traefik's dashboard port
      # - name: reverse-proxy = The Traefik Service from 0304-traefik-service.yaml
      # - port: 8080 = Dashboard/API port
      # - Behavior: After path rewrite, forwards to port 8080
      # - Result: /traefik/dashboard → rewrite to /dashboard → port 8080
      backendRefs:
        - name: reverse-proxy
          port: 8080

